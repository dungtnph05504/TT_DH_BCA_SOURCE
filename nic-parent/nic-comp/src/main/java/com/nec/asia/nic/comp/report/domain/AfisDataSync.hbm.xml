<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
                                   "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping schema="EPP_CENTRAL">
 
 <sql-query name="report.getSynchronizionDetails">
 <![CDATA[
    WITH
        TOT_TRANS AS
        (
            SELECT TO_CHAR(NT.DATE_OF_APPLICATION,'DD-MM-YYYY') APP_DATE, COUNT(DISTINCT TRANSACTION_ID) TOT_TRANS_CNT FROM EPP_TRANSACTION NT
            WHERE TO_CHAR(NT.DATE_OF_APPLICATION,'MM-YYYY')=:appMonthYear
            group by TO_CHAR(NT.DATE_OF_APPLICATION,'DD-MM-YYYY')
        ),
        TRANS_IDS AS
        (
            SELECT DISTINCT TRANSACTION_ID, DATE_OF_APPLICATION FROM EPP_TRANSACTION NT
            WHERE TO_CHAR(NT.DATE_OF_APPLICATION,'MM-YYYY')=:appMonthYear
        ),
        SYN_COUNT AS
        (
            SELECT TO_CHAR(NT.DATE_OF_APPLICATION,'DD-MM-YYYY') APP_DATE, COUNT(DISTINCT NT.TRANSACTION_ID) TOT_SYN_COUNT FROM TRANS_IDS NT, BAF_LATEST_DATASYNC BDS 
            WHERE
                NT.TRANSACTION_ID = BDS.TRANSACTION_ID
                AND BDS.SYNC_STATUS = 3000
                group by TO_CHAR(NT.DATE_OF_APPLICATION,'DD-MM-YYYY')
        ),
        NOT_SYN_COUNT AS
        (
            SELECT TO_CHAR(NT.DATE_OF_APPLICATION,'DD-MM-YYYY') APP_DATE, COUNT(DISTINCT NT.TRANSACTION_ID) TOT_NSC_CNT FROM TRANS_IDS NT, BAF_LATEST_DATASYNC BDS, EPP_WORKFLOW_JOB NUJ
            WHERE
                NUJ.TRANSACTION_ID = NT.TRANSACTION_ID
                AND INVESTIGATION_TYPE = 'CPD'
                AND INVESTIGATION_STATUS IN ('04','05')
                AND NT.TRANSACTION_ID <> BDS.TRANSACTION_ID
                group by TO_CHAR(NT.DATE_OF_APPLICATION,'DD-MM-YYYY')
        )
    SELECT TTC.APP_DATE , TOT_TRANS_CNT , NVL(TOT_SYN_COUNT, 0), NVL(TOT_NSC_CNT,0)  FROM TOT_TRANS TTC, SYN_COUNT TSC, NOT_SYN_COUNT NSC
    WHERE TSC.APP_DATE(+)=TTC.APP_DATE AND
        NSC.APP_DATE(+)=TTC.APP_DATE
    ORDER BY TTC.APP_DATE DESC
 
 ]]>
 </sql-query>
 
<sql-query name="report.getSynchronizionDetailsByDate">
 <![CDATA[
    WITH
        TRANS_IDS AS (
            SELECT DISTINCT TRANSACTION_ID, DATE_OF_APPLICATION FROM EPP_TRANSACTION NT
            WHERE TO_CHAR(NT.DATE_OF_APPLICATION,'DD-MM-YYYY')=:appDate
        ),
        NOT_SYN_COUNT AS (
            SELECT        DISTINCT NT.TRANSACTION_ID TRANSACTION_ID FROM TRANS_IDS NT, BAF_LATEST_DATASYNC BDS , EPP_WORKFLOW_JOB NUJ
            WHERE
                NUJ.TRANSACTION_ID = NT.TRANSACTION_ID
                AND INVESTIGATION_TYPE = 'CPD'
                AND INVESTIGATION_STATUS IN ('04','05')
                AND NT.TRANSACTION_ID <> BDS.TRANSACTION_ID
        )
        
    SELECT NT.TRANSACTION_ID,NT.APPLN_REF_NO,NT.TRANSACTION_TYPE,NT.REG_SITE_CODE,BLS.SYNC_TRIES,BLS.SYNC_STATUS,BLS.ERROR_DESC, BLS.DATASYNC_ID, NT.TRANSACTION_STATUS
    FROM EPP_TRANSACTION NT, BAF_LATEST_DATASYNC BLS
    WHERE BLS.TRANSACTION_ID (+)= NT.TRANSACTION_ID 
        AND NT.TRANSACTION_ID NOT IN ( SELECT TRANSACTION_ID FROM NOT_SYN_COUNT NSC)
        AND TO_CHAR(NT.DATE_OF_APPLICATION,'DD-MM-YYYY')=:appDate
        AND (BLS.SYNC_STATUS <> 3000 or BLS.SYNC_STATUS is null)
        
]]>	
 </sql-query>
 
<sql-query name="report.getSynchronizionDetailsByMonth">
<![CDATA[
    WITH
        TRANS_IDS AS (
            SELECT DISTINCT TRANSACTION_ID, DATE_OF_APPLICATION FROM EPP_TRANSACTION NT
            WHERE TO_CHAR(NT.DATE_OF_APPLICATION,'MM-YYYY')=:appDate
        ),
        NOT_SYN_COUNT AS (
            SELECT  DISTINCT NT.TRANSACTION_ID TRANSACTION_ID FROM TRANS_IDS NT, BAF_LATEST_DATASYNC BDS , EPP_WORKFLOW_JOB NUJ
            WHERE
                NUJ.TRANSACTION_ID = NT.TRANSACTION_ID
                AND INVESTIGATION_TYPE = 'CPD'
                AND INVESTIGATION_STATUS IN ('04','05')
                AND NT.TRANSACTION_ID <> BDS.TRANSACTION_ID
        )
    SELECT NT.TRANSACTION_ID,NT.APPLN_REF_NO,NT.TRANSACTION_TYPE,NT.REG_SITE_CODE,BLS.SYNC_TRIES,BLS.SYNC_STATUS,BLS.ERROR_DESC, BLS.DATASYNC_ID, NT.TRANSACTION_STATUS
    FROM EPP_TRANSACTION NT, BAF_LATEST_DATASYNC BLS
    WHERE BLS.TRANSACTION_ID (+)= NT.TRANSACTION_ID 
        AND NT.TRANSACTION_ID NOT IN (SELECT TRANSACTION_ID FROM NOT_SYN_COUNT NSC)
        AND TO_CHAR(NT.DATE_OF_APPLICATION,'MM-YYYY')=:appDate
        AND (BLS.SYNC_STATUS <> 3000 or BLS.SYNC_STATUS is null)
 ]]>
 </sql-query>

<sql-query name="report.getSyncRequestAndStatusDet">
<![CDATA[
    SELECT TO_CHAR(bds.DATETIME_CREATE,'DD-Mon-YYYY HH24:MI') as DATETIME_CREATE, TO_CHAR(bds.DATETIME_UPDATE,'DD-Mon-YYYY HH24:MI') as DATETIME_UPDATE,
        bds.SYNC_MODE,bds.SYNC_STATUS,bds.SYNC_TRIES,bds.ERROR_DESC, BDS.DATASYNC_ID
    FROM EPP_AFIS_DATA NAD, BAF_BIO_DATASYNC BDS
    WHERE NAD.TRANSACTION_ID = :transId AND 
        NAD.AFIS_REF_ID = bds.REGISTRATION_ID 
    ORDER BY BdS.DATETIME_CREATE DESC, bds.DATETIME_UPDATE DESC
 ]]>
</sql-query> 
 
<sql-query name="resetDataSyncRequest">
<![CDATA[
    UPDATE BAF_BIO_DATASYNC  
        SET SYNC_STATUS=2000, ERROR_DESC=NULL, SYNC_TRIES=0
    WHERE DATASYNC_ID = :dataSyncId
        AND SYNC_STATUS = 4000
]]>	

</sql-query> 
 
 
 
 
 
</hibernate-mapping>
